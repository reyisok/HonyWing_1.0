<UserControl x:Class="HonyWing.UI.Controls.LogViewer"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:converters="clr-namespace:HonyWing.UI.Converters"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="800">

    <UserControl.Resources>
        <converters:LogLevelToColorConverter x:Key="LogLevelToColorConverter" />
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />

        <!-- 日志行样式 -->
        <Style x:Key="LogRowStyle" TargetType="DataGridRow">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="#E0E0E0" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="MinHeight" Value="22" />
            <Setter Property="Height" Value="22" />
            <Setter Property="Margin" Value="0" />
            <Setter Property="Padding" Value="2,1,2,1" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#33555555" />
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#33555555" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- 通用单元格样式 -->
        <Style x:Key="BaseCellStyle" TargetType="DataGridCell">
            <Setter Property="Padding" Value="0" />
            <Setter Property="Margin" Value="0" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>

        <!-- 日志级别单元格样式 -->
        <Style x:Key="LogLevelCellStyle" TargetType="DataGridCell" BasedOn="{StaticResource BaseCellStyle}">
            <Setter Property="Foreground" Value="{Binding Level, Converter={StaticResource LogLevelToColorConverter}}" />
            <Setter Property="FontWeight" Value="Bold" />
            <Setter Property="HorizontalAlignment" Value="Center" />
        </Style>

        <!-- 时间戳单元格样式 -->
        <Style x:Key="TimestampCellStyle" TargetType="DataGridCell" BasedOn="{StaticResource BaseCellStyle}">
            <Setter Property="Foreground" Value="#666666" />
            <Setter Property="FontFamily" Value="Consolas, Courier New" />
            <Setter Property="FontSize" Value="12" />
        </Style>

        <!-- 消息单元格样式 -->
        <Style x:Key="MessageCellStyle" TargetType="DataGridCell" BasedOn="{StaticResource BaseCellStyle}">
            <Setter Property="ToolTip" Value="{Binding FormattedMessage}" />
        </Style>

        <!-- DataGrid列标题样式 -->
        <Style x:Key="LogHeaderStyle" TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="#FF1E3A5F"/>
            <Setter Property="Foreground" Value="#FFCCCCCC"/>
            <Setter Property="BorderBrush" Value="#FF3A5A80"/>
            <Setter Property="BorderThickness" Value="0,0,1,1"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- 工具栏 -->
        <Border Grid.Row="0" Background="#FF1E3A5F" BorderBrush="#FF3A5A80" BorderThickness="0,0,0,1" Padding="10,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="150" />
                    <ColumnDefinition Width="10" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="200" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- 级别过滤 -->
                <TextBlock Grid.Column="0" Text="Level:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="#FFCCCCCC" />
                <ComboBox Grid.Column="1" x:Name="LevelFilterComboBox" SelectedValue="{Binding FilterLevel, Mode=TwoWay}" SelectedValuePath="Content" Background="#FF1E1E1E" Foreground="#FFCCCCCC" MinWidth="120" Width="150">
                    <ComboBoxItem Content="All" />
                    <ComboBoxItem Content="Trace" />
                    <ComboBoxItem Content="Debug" />
                    <ComboBoxItem Content="Info" />
                    <ComboBoxItem Content="Warn" />
                    <ComboBoxItem Content="Error" />
                    <ComboBoxItem Content="Fatal" />
                </ComboBox>

                <!-- 搜索 -->
                <TextBlock Grid.Column="3" Text="Search:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="#FFCCCCCC" />
                <TextBox Grid.Column="4" x:Name="SearchTextBox"
                         Text="{Binding SearchKeyword, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         VerticalAlignment="Center" Padding="5,3" Background="#FF1E1E1E" Foreground="#FFCCCCCC" BorderBrush="#FF3F3F46"
                         KeyDown="SearchTextBox_KeyDown">
                    <TextBox.Style>
                        <Style TargetType="TextBox">
                            <Setter Property="Background" Value="#FF1E1E1E" />
                            <Setter Property="Foreground" Value="#FFCCCCCC" />
                            <Setter Property="BorderBrush" Value="#FF3F3F46" />
                            <Style.Triggers>
                                <Trigger Property="Text" Value="">
                                    <Setter Property="Background">
                                        <Setter.Value>
                                            <VisualBrush AlignmentX="Left" AlignmentY="Center" Stretch="None">
                                                <VisualBrush.Visual>
                                                    <Label Content="Enter keywords to search..." Foreground="#FF888888" Background="#FF1E1E1E" />
                                                </VisualBrush.Visual>
                                            </VisualBrush>
                                        </Setter.Value>
                                    </Setter>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </TextBox.Style>
                </TextBox>

                <!-- 滚动控制按钮 -->
                <StackPanel Grid.Column="6" Orientation="Horizontal" Margin="10,0,0,0">
                    <Button x:Name="ScrollToggleButton" Content="停止滚动" Click="ScrollToggleButton_Click"
                            Padding="10,3" Background="#FF007ACC" Foreground="White" BorderBrush="#FF3F3F46" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- 日志列表 -->
        <DataGrid Grid.Row="1" x:Name="LogDataGrid"
                  ItemsSource="{Binding FilteredLogs}"
                  AutoGenerateColumns="False"
                  IsReadOnly="True"
                  GridLinesVisibility="None"
                  HeadersVisibility="Column"
                  RowStyle="{StaticResource LogRowStyle}"
                  ColumnHeaderStyle="{StaticResource LogHeaderStyle}"
                  SelectionMode="Extended"
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  CanUserReorderColumns="True"
                  CanUserResizeColumns="True"
                  CanUserResizeRows="False"
                  CanUserSortColumns="True"
                  VirtualizingPanel.IsVirtualizing="True"
                  VirtualizingPanel.VirtualizationMode="Recycling"
                  ScrollViewer.CanContentScroll="True"
                  Background="#FF1E1E1E" Foreground="#FFCCCCCC"
                  FontSize="12">

            <DataGrid.Columns>
                <!-- 时间列 -->
                <DataGridTextColumn Header="时间" Binding="{Binding TimeString}"
                                    Width="80" CellStyle="{StaticResource TimestampCellStyle}" />

                <!-- 级别列 -->
                <DataGridTextColumn Header="级别" Binding="{Binding Level}"
                                    Width="60" CellStyle="{StaticResource LogLevelCellStyle}" />

                <!-- 记录器列 -->
                <DataGridTextColumn Header="记录器" Binding="{Binding Logger}"
                                    Width="150" />

                <!-- 消息列 -->
                <DataGridTextColumn Header="消息" Binding="{Binding Message}"
                                    Width="*" CellStyle="{StaticResource MessageCellStyle}" />
            </DataGrid.Columns>
        </DataGrid>

        <!-- 状态栏 -->
        <Border Grid.Row="2" Background="#FF2D2D30" BorderBrush="#FF3F3F46" BorderThickness="0,1,0,0" Padding="10,5">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" VerticalAlignment="Center" Foreground="#FFCCCCCC">
                    <Run Text="Total: " />
                    <Run Text="{Binding TotalLogCount, Mode=OneWay}" FontWeight="Bold" />
                    <Run Text=" items" />
                    <Run Text="  |  Filtered: " />
                    <Run Text="{Binding FilteredLogCount, Mode=OneWay}" FontWeight="Bold" />
                    <Run Text=" items" />
                </TextBlock>

                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                    <TextBlock Text="Max Entries:" VerticalAlignment="Center" Margin="0,0,5,0" Foreground="#FFCCCCCC" />
                    <TextBox Text="{Binding MaxLogEntries, Mode=TwoWay}"
                             Width="80" VerticalAlignment="Center"
                             Padding="3" Background="#FF1E1E1E" Foreground="#FFCCCCCC" BorderBrush="#FF3F3F46" />
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
